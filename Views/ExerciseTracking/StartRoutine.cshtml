@model GymQuest.Models.ViewModels.StartRoutineViewModel

@{
    ViewData["Title"] = "Start Routine";
    var exercises = ViewBag.Exercises as List<GymQuest.Models.Exercises>; // Ensure correct type
}

<h2>@Model.RoutineName - @Model.DayName</h2>

@if (!Model.PlannedExercises.Any())
{
    <p>No exercises are planned for today.</p>
    <button type="button" class="btn btn-secondary" onclick="openAddExerciseModal('@Model.DayName')">Add Exercise</button>
}

@foreach (var exercise in Model.PlannedExercises)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Exercise</th>
                <th>Set</th>
                <th>Reps</th>
                <th>Weight (lbs)</th>
                <th>Completed</th>
                <th>Failed Rep</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in Model.PlannedExercises)
            {
                for (int set = 1; set <= exercise.Sets; set++)
                {
                    <tr>
                        @if (set == 1)
                        {
                            <td rowspan="@exercise.Sets">@exercise.ExerciseName</td>
                        }
                        <td>@set</td>
                        <td>@exercise.Reps</td>
                        <td>@exercise.Weight</td>
                        <td>
                            <input type="checkbox" asp-for="@exercise.IsSuccessful" name="isSuccessful[@exercise.PlannedExerciseId][@set]" />
                        </td>
                        <td>
                            <input type="number" asp-for="@exercise.FailedRep" name="failedRep[@exercise.PlannedExerciseId][@set]" min="0" max="@exercise.Reps" class="form-control" />
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

<!-- Modal for adding a new exercise -->
<div class="modal fade" id="addExerciseModal" tabindex="-1" role="dialog" aria-labelledby="addExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addExerciseModalLabel">Add New Exercise</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addExerciseForm">
                    <input type="hidden" id="workoutDayName" name="dayName" value="@Model.DayName" />
                    <input type="hidden" id="workoutRoutineId" name="workoutRoutineId" value="@Model.WorkoutRoutineId" />

                    <div class="form-group">
                        <label for="exerciseId">Exercise:</label>
                        <select id="exerciseId" name="exerciseId" class="form-control">
                            <option value="">-- Select Exercise --</option>
                            @foreach (var exercise in exercises)
                            {
                                <option value="@exercise.ExerciseId">@exercise.Name</option>
                            }
                        </select>
                        <button type="button" class="btn btn-link" onclick="openCreateExerciseModal()">+ Create New Exercise</button>
                    </div>

                    <div class="form-group">
                        <label for="sets">Sets:</label>
                        <input type="number" id="sets" name="sets" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label for="reps">Reps:</label>
                        <input type="number" id="reps" name="reps" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label for="weight">Weight (lbs):</label>
                        <input type="number" id="weight" name="weight" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (optional):</label>
                        <textarea id="notes" name="notes" class="form-control"></textarea>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveExercise()">Save Exercise</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for creating a new exercise -->
<div class="modal fade" id="createExerciseModal" tabindex="-1" role="dialog" aria-labelledby="createExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createExerciseModalLabel">Create New Exercise</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createExerciseForm">
                    <div class="form-group">
                        <label for="exerciseName">Exercise Name</label>
                        <input type="text" class="form-control" id="exerciseName" name="exerciseName" required />
                    </div>
                    <div class="form-group">
                        <label for="exerciseDescription">Description (optional)</label>
                        <textarea class="form-control" id="exerciseDescription" name="exerciseDescription"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="submitNewExercise()">Save Exercise</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        function openAddExerciseModal(dayName) {
            console.log(dayName);
            $('#workoutDayName').val(dayName);
            $('#addExerciseModal').modal('show');
        }

        function openCreateExerciseModal() {
            $('#createExerciseModal').modal('show');
        }

        function saveExercise() {
            var workoutRoutineId = $('#workoutRoutineId').val();
            var dayName = $('#workoutDayName').val();
            var exerciseId = $('#exerciseId').val();
            var sets = $('#sets').val();
            var reps = $('#reps').val();
            var weight = $('#weight').val();
            var notes = $('#notes').val();

            $.ajax({
                url: '@Url.Action("AddExerciseToDay", "ExerciseTracking")',
                type: 'POST',
                data: {
                    workoutRoutineId: workoutRoutineId,
                    dayName: dayName,
                    exerciseId: exerciseId,
                    sets: sets,
                    reps: reps,
                    weight: weight,
                    notes: notes
                },
                success: function (response) {
                    // Append the new exercise to the correct day in the view
                    $('#exerciseList-' + dayName).append('<li>' + response.exerciseName + ' - ' + sets + ' sets of ' + reps + ' reps at ' + weight + ' lbs</li>');
                    $('#addExerciseModal').modal('hide');
                },
                error: function (xhr, status, error) {
                    console.error('Error details:', xhr.responseText);
                    console.error('Status:', status);
                    console.error('Error:', error);
                    alert("An error occurred while adding the exercise. Please try again.");
                }
            });
        }

        function submitNewExercise() {
            var exerciseName = $('#exerciseName').val();
            var exerciseDescription = $('#exerciseDescription').val();

            $.ajax({
                url: '@Url.Action("CreateExercise", "ExerciseTracking")',
                type: 'POST',
                data: {
                    name: exerciseName,
                    description: exerciseDescription
                },
                success: function (newExercise) {
                    $('#createExerciseModal').modal('hide');
                    // Add the new exercise to the dropdown list
                    $('#exerciseId').append(new Option(newExercise.name, newExercise.exerciseId));
                    // Automatically select the new exercise
                    $('#exerciseId').val(newExercise.exerciseId);
                },
                error: function () {
                    alert("An error occurred while creating the exercise. Please try again.");
                }
            });
        }
    </script>
}
